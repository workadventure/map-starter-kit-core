<!DOCTYPE html>
<html lang="en">

{{> head}}

<body>
<div class="content">
    {{> header}}
    <main class="container">
        <section id="configureSteps" class="form-center steps">
            <input type="hidden" id="stepProgress" value="1" />
            <div id="step1" class="step">
                <div class="step-title">
                    <div class="step-number">1</div>
                    <h2>Log into your WorkAdventure dashboard</h2>
                </div>
                <div>
                    <button id="bo-connect" class="btn">Go to the API keys page</button>
                </div>
            </div>

            <div id="step2" class="step inactive">
                <div class="step-title">
                    <div class="step-number">2</div>
                    <h2>Complete the URL of your map storage</h2>
                </div>
                <div class="alert">
                    <div class="alert-text">
                        Be careful to select the proper world just above before copying your map storage url and create your key
                    </div>
                    <img src="public/images/world-select.png" alt="World selection" />
                </div>
                <div class="step-text">
                    In the left panel, click on "Developers" tab then "API keys / Zapier". There are 3 links, be careful to take the Map-storage API endpoint, it is the url for uploading files to the map storage service of WorkAdventure.
                </div>
                <div style="margin-top: 8px;">
                    <input id="mapStorageURL" type="url" placeholder="Paste here the Map-storage API endpoint..." value="{{mapStorageUrl}}" />
                </div>
            </div>

            <div id="step3" class="step inactive">
                <div class="step-title">
                    <div class="step-number">3</div>
                    <h2>Add your map storage API Key</h2>
                </div>
                <div class="step-text">
                    Copy your API key from the WorkAdventure dashboard and paste it in the field below.<br/>
                    If there is no API key yet, you can create one by following these steps:
                    <ol>
                        <li>Click the "Create a new token" button in the dashboard</li>
                        <li>Refresh the page</li>
                        <li>Click on the “Copy” button next to your token</li>
                    </ol>
                </div>
                <div>
                    <input id="apiKey"
                     type="password"
                     placeholder="Paste here your API Key..." 
                     value="{{mapStorageApiKey}}"
                     autocomplete="off"
                    />
                </div>
            </div>

            <div id="step4" class="step inactive">
                <div class="step-title">
                    <div class="step-number">4</div>
                    <h2>Choose a name / directory for your maps</h2>
                </div>
                <div class="step-text">
                    <p>The maps you upload will be stored in this directory in our map storage.</p>

                    <div class="alert">
                        <div class="alert-text">
                            Anything in this directory will be overwritten when you upload, so be careful to choose a
                            unique name or a name that matches the world you want to update if you already have one.
                        </div>
                    </div>

                    <p>The directory will be visible in the URL of your maps.</p>
                </div>
                <div>
                    <input id="uploadDirectory" type="text" placeholder="Name of your world" value="{{uploadDirectory}}" />
                </div>
            </div>
        </section>
    </main>
    <div class="button-wrapper">
        <div>
            <a href="step2-hosting" class="btn btn-ghost">
                Previous
            </a>
        </div>
        <div style="flex-grow: 1;">
        </div>
        <div>
            <button id="saveButton" class="btn btn-secondary">
                Upload
            </button>
        </div>
    </div>
</div>
{{> footer}}
<script>
    let stepProgress = document.getElementById('stepProgress');
    let step1 = document.getElementById('step1');
    let step2 = document.getElementById('step2');
    let step3 = document.getElementById('step3');
    let step4 = document.getElementById('step4');
    let mapStorageURL = document.getElementById('mapStorageURL');
    let apiKey = document.getElementById('apiKey');
    let uploadDirectory = document.getElementById('uploadDirectory');
    const button = document.getElementById("bo-connect");
    const saveButton = document.getElementById("saveButton");
    let formIsValid = false;

    // Function to validate map storage URL
    function isValidMapStorageUrl(value) {
        if (typeof window.isSaasMapStorageUrl === 'function') {
            return window.isSaasMapStorageUrl(value);
        }
        const regex = /^https:\/\/[a-zA-Z0-9.-]+\.map-storage\.workadventu\.re\/?$/;
        return regex.test(value);
    }

    function revealStep(step) {
        step.style.opacity = 1;
        step.classList.remove("inactive");
    }

    function applyPrefillState() {
        let currentStep = 1;

        if (mapStorageURL.value) {
            revealStep(step2);
            currentStep = 2;
            if (isValidMapStorageUrl(mapStorageURL.value)) {
                mapStorageURL.classList.remove("error");
                mapStorageURL.classList.add("success");
                revealStep(step3);
                currentStep = 3;
                formIsValid = 1;
            } else {
                mapStorageURL.classList.remove("success");
                mapStorageURL.classList.add("error");
            }
        }

        if (apiKey.value) {
            apiKey.classList.remove("error");
            apiKey.classList.add("success");
            revealStep(step3);
            revealStep(step4);
            currentStep = 4;
            formIsValid = 2;
        }

        if (uploadDirectory.value) {
            uploadDirectory.classList.remove("error");
            uploadDirectory.classList.add("success");
            revealStep(step4);
            currentStep = 4;
            formIsValid = 3;
        }

        if (currentStep > 1) {
            stepProgress.value = currentStep;
        }
    }

    applyPrefillState();

    button.addEventListener("click", (event) => {
        stepProgress.value = 2;
        step2.style.opacity = 1;
        step2.classList.remove("inactive");
        // Scroll to step 2
        step2.scrollIntoView({ behavior: "smooth" });
        // Open new window to "https://admin.workadventu.re/login"
        window.open("https://admin.workadventu.re/_/api-settings", "_blank");
    });

    mapStorageURL.addEventListener('input', function (evt) {
        if(isValidMapStorageUrl(this.value)) {
            mapStorageURL.classList.remove("error");
            mapStorageURL.classList.add("success");
            setTimeout(function() {
                step3.style.opacity = 1;
                step3.classList.remove("inactive");
                // Scroll to step 3
                step3.scrollIntoView({ behavior: "smooth" });
            }, 500);
            formIsValid++;
        } else {
            mapStorageURL.classList.remove("success");
            mapStorageURL.classList.add("error");
            formIsValid = false;
        }
    });

    apiKey.addEventListener('input', function (evt) {
        if(this.value) {
            apiKey.classList.remove("error");
            apiKey.classList.add("success");
            setTimeout(function() {
                step4.style.opacity = 1;
                step4.classList.remove("inactive");
                // Scroll to step 4
                console.log('Scroll to step 4');
                step4.scrollIntoView({ behavior: "smooth" });
                formIsValid++;
            }, 500);
        } else {
            apiKey.classList.remove("success");
            apiKey.classList.add("error");
            formIsValid = false;
        }
    });

    uploadDirectory.addEventListener('input', function (evt) {
        if(this.value) {
            uploadDirectory.classList.remove("error");
            uploadDirectory.classList.add("success");
            formIsValid++;
        } else {
            uploadDirectory.classList.remove("success");
            uploadDirectory.classList.add("error");
            formIsValid = false;
        }
    });

    saveButton.addEventListener("click", async (event) => {
        // Validate form before proceeding
        if (!mapStorageURL.value || !isValidMapStorageUrl(mapStorageURL.value) || 
            !apiKey.value || !uploadDirectory.value) {
            showErrorPopup('Please fill in all required fields correctly.');
            return;
        }

        const startTime = Date.now();
        const minDuration = 2000; // 2 seconds

        try {
            if (typeof window.showLoadingOverlay === 'function') {
                window.showLoadingOverlay('Saving your configuration...');
            }
            // Send the form data to the server to configure
            const configureResponse = await fetch("/uploader/configure", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    mapStorageUrl: mapStorageURL.value,
                    mapStorageApiKey: apiKey.value,
                    uploadDirectory: uploadDirectory.value
                })
            });

            if (!configureResponse.ok) {
                const errorData = await configureResponse.json().catch(() => ({}));
                throw new Error(errorData.message || errorData.error || 'Failed to save configuration. Please check your inputs and try again.');
            }

            const configureData = await configureResponse.json();

            // Update loading message
            if (typeof window.showLoadingOverlay === 'function') {
                window.showLoadingOverlay('Uploading your map...');
            }

            // Upload the map
            const uploadResponse = await fetch("/uploader/upload", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                }
            });

            if (!uploadResponse.ok) {
                const errorData = await uploadResponse.json().catch(() => ({}));
                const errorMsg = errorData.message || errorData.error || 'Failed to upload map. Please verify your configuration and try again.';
                throw new Error(errorMsg);
            }

            // Ensure minimum 2 seconds have passed
            const elapsed = Date.now() - startTime;
            if (elapsed < minDuration) {
                await new Promise(resolve => setTimeout(resolve, minDuration - elapsed));
            }
            
            // Redirect to success page
            const redirectUrl = typeof window.getPostPublishRedirect === 'function'
                ? window.getPostPublishRedirect(mapStorageURL.value)
                : '/step4-validated';
            window.location.href = redirectUrl;
        } catch (error) {
            console.error('Error saving configuration:', error);
            // Hide loading overlay on error
            if (typeof window.hideLoadingOverlay === 'function') {
                window.hideLoadingOverlay();
            }
            
            // Show error popup with a user-friendly message
            const errorMessage = error instanceof Error ? error.message : 'An error occurred while saving your configuration. Please try again.';
            showErrorPopup(errorMessage);
        }
    });
</script>
</body>

</html>
