<!DOCTYPE html>
<html lang="en">

{{> head}}

<body>
<div class="content">
    {{> header}}
    <main class="container">
        <section id="configureSteps" class="form-center steps">
            <input type="hidden" id="stepProgress" value="1" />
            <div id="step1" class="step">
                <div class="step-title">
                    <div class="step-number">1</div>
                    <h2>Gather your WorkAdventure credentials</h2>
                </div>
                <div class="step-text">
                    <p>You will need help from your WorkAdventure administrator for this step. Please ask them to provide you
                        with the URL and API token of your map storage service.</p>

                    <ul>
                        <li>
                            If your WorkAdventure instance was deployed with <strong>docker-compose</strong>, the URL is
                            most often <code>https://[your-server-url]/map-storage/</code>, and the API token can be found in
                            the <code>.env</code> file under the variable <strong>MAP_STORAGE_API_TOKEN</strong>.
                        </li>
                        <li>
                            If your WorkAdventure instance was deployed using the <strong>Kubernetes Helm chart</strong>, the URL is
                            most often <code>https://[your-server-url]/map-storage/</code>
                            (or <code>https://map-storage.[your-server-url]/</code>) if you are using <code>singleDomain: false</code> in your <code>values.yaml</code> file.
                            The API token can be found in <code>values.yaml</code> under the key <code>commonSecretEnv.MAP_STORAGE_API_TOKEN</code>.
                        </li>
                    </ul>
                </div>
                <div style="margin-top: 16px;">
                    <button id="step1-done" class="btn">I have the credentials</button>
                </div>
            </div>

            <div id="step2" class="step inactive">
                <div class="step-title">
                    <div class="step-number">2</div>
                    <h2>Copy your Map storage URL</h2>
                </div>
                <div class="step-text">
                    Refer to the instructions in step 1 to find the URL of your map storage service.
                </div>
                <div style="margin-top: 8px;">
                    <input id="mapStorageURL" type="url" placeholder="Paste here your map-storage URL..." value="{{mapStorageUrl}}" />
                </div>
            </div>

            <div id="step3" class="step inactive">
                <div class="step-title">
                    <div class="step-number">3</div>
                    <h2>Copy your Map storage API token</h2>
                </div>
                <div class="step-text">
                    Refer to the instructions in step 1 to find the API token of your map storage service. It is a long
                    string of letters and numbers that serves as a password to authenticate your uploads.
                </div>
                <div>
                    <input id="apiKey"
                     type="password"
                     placeholder="Paste here your MAP_STORAGE_API_TOKEN..."
                     value="{{mapStorageApiKey}}"
                     autocomplete="off"
                    />
                </div>
            </div>

            <div id="step4" class="step inactive">
                <div class="step-title">
                    <div class="step-number">4</div>
                    <h2>Choose a name / directory for your maps</h2>
                </div>
                <div class="step-text">
                    <p>The maps you upload will be stored in this directory in our map storage.</p>

                    <div class="alert">
                        <div class="alert-text">
                            Anything in this directory will be overwritten when you upload, so be careful to choose a
                            unique name or a name that matches the world you want to update if you already have one.
                        </div>
                    </div>

                    <p>The directory will be visible in the URL of your maps.</p>
                </div>
                <div>
                    <input id="uploadDirectory" type="text" placeholder="Name of your world" value="{{uploadDirectory}}" />
                </div>
            </div>
        </section>
    </main>
    <div class="button-wrapper">
        <div>
            <a href="step2-hosting" class="btn btn-ghost">
                Previous
            </a>
        </div>
        <div style="flex-grow: 1;">
        </div>
        <div>
            <button id="saveButton" class="btn btn-secondary">
                Upload
            </button>
        </div>
    </div>
</div>
{{> footer}}
<script>
    let stepProgress = document.getElementById('stepProgress');
    let step1 = document.getElementById('step1');
    let step2 = document.getElementById('step2');
    let step3 = document.getElementById('step3');
    let step4 = document.getElementById('step4');
    let mapStorageURL = document.getElementById('mapStorageURL');
    let apiKey = document.getElementById('apiKey');
    let uploadDirectory = document.getElementById('uploadDirectory');
    const step1DoneButton = document.getElementById("step1-done");
    const saveButton = document.getElementById("saveButton");
    let formIsValid = false;

    // For self-hosted: accept any valid HTTPS URL (not only workadventu.re)
    function isValidMapStorageUrl(value) {
        try {
            const url = new URL(value);
            return url.protocol === 'https:' || url.protocol === 'http:';
        } catch {
            return false;
        }
    }

    function revealStep(step) {
        step.style.opacity = 1;
        step.classList.remove("inactive");
    }

    function applyPrefillState() {
        let currentStep = 1;

        if (mapStorageURL.value) {
            revealStep(step2);
            currentStep = 2;
            if (isValidMapStorageUrl(mapStorageURL.value)) {
                mapStorageURL.classList.remove("error");
                mapStorageURL.classList.add("success");
                revealStep(step3);
                currentStep = 3;
                formIsValid = 1;
            } else {
                mapStorageURL.classList.remove("success");
                mapStorageURL.classList.add("error");
            }
        }

        if (apiKey.value) {
            apiKey.classList.remove("error");
            apiKey.classList.add("success");
            revealStep(step3);
            revealStep(step4);
            currentStep = 4;
            formIsValid = 2;
        }

        if (uploadDirectory.value) {
            uploadDirectory.classList.remove("error");
            uploadDirectory.classList.add("success");
            revealStep(step4);
            currentStep = 4;
            formIsValid = 3;
        }

        if (currentStep > 1) {
            stepProgress.value = currentStep;
        }
    }

    applyPrefillState();

    step1DoneButton.addEventListener("click", (event) => {
        stepProgress.value = 2;
        step2.style.opacity = 1;
        step2.classList.remove("inactive");
        step2.scrollIntoView({ behavior: "smooth" });
    });

    mapStorageURL.addEventListener('input', function (evt) {
        if (isValidMapStorageUrl(this.value)) {
            mapStorageURL.classList.remove("error");
            mapStorageURL.classList.add("success");
            setTimeout(function () {
                step3.style.opacity = 1;
                step3.classList.remove("inactive");
                step3.scrollIntoView({ behavior: "smooth" });
            }, 500);
            formIsValid++;
        } else {
            mapStorageURL.classList.remove("success");
            mapStorageURL.classList.add("error");
            formIsValid = false;
        }
    });

    apiKey.addEventListener('input', function (evt) {
        if (this.value) {
            apiKey.classList.remove("error");
            apiKey.classList.add("success");
            setTimeout(function () {
                step4.style.opacity = 1;
                step4.classList.remove("inactive");
                step4.scrollIntoView({ behavior: "smooth" });
                formIsValid++;
            }, 500);
        } else {
            apiKey.classList.remove("success");
            apiKey.classList.add("error");
            formIsValid = false;
        }
    });

    uploadDirectory.addEventListener('input', function (evt) {
        if (this.value) {
            uploadDirectory.classList.remove("error");
            uploadDirectory.classList.add("success");
            formIsValid++;
        } else {
            uploadDirectory.classList.remove("success");
            uploadDirectory.classList.add("error");
            formIsValid = false;
        }
    });

    saveButton.addEventListener("click", async (event) => {
        if (!mapStorageURL.value || !isValidMapStorageUrl(mapStorageURL.value) ||
            !apiKey.value || !uploadDirectory.value) {
            showErrorPopup('Please fill in all required fields correctly.');
            return;
        }

        const startTime = Date.now();
        const minDuration = 2000;

        try {
            if (typeof window.showLoadingOverlay === 'function') {
                window.showLoadingOverlay('Saving your configuration...');
            }

            const configureResponse = await fetch("/uploader/configure", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    mapStorageUrl: mapStorageURL.value,
                    mapStorageApiKey: apiKey.value,
                    uploadDirectory: uploadDirectory.value
                })
            });

            if (!configureResponse.ok) {
                const errorData = await configureResponse.json().catch(() => ({}));
                throw new Error(errorData.message || errorData.error || 'Failed to save configuration. Please check your inputs and try again.');
            }

            if (typeof window.showLoadingOverlay === 'function') {
                window.showLoadingOverlay('Uploading your map...');
            }

            const uploadResponse = await fetch("/uploader/upload", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                }
            });

            if (!uploadResponse.ok) {
                const errorData = await uploadResponse.json().catch(() => ({}));
                const errorMsg = errorData.message || errorData.error || 'Failed to upload map. Please verify your configuration and try again.';
                throw new Error(errorMsg);
            }

            const elapsed = Date.now() - startTime;
            if (elapsed < minDuration) {
                await new Promise(resolve => setTimeout(resolve, minDuration - elapsed));
            }

            const redirectUrl = typeof window.getPostPublishRedirect === 'function'
                ? window.getPostPublishRedirect(mapStorageURL.value)
                : '/step4-validated-selfhosted';
            window.location.href = redirectUrl;
        } catch (error) {
            console.error('Error saving configuration:', error);
            if (typeof window.hideLoadingOverlay === 'function') {
                window.hideLoadingOverlay();
            }

            const errorMessage = error instanceof Error ? error.message : 'An error occurred while saving your configuration. Please try again.';
            showErrorPopup(errorMessage);
        }
    });
</script>
<style>
    .step-text code {
        background: rgba(255, 255, 255, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: monospace;
    }
</style>
</body>

</html>
